<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{{ title }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>

    <!-- <img style="position:fixed; left: 48%; transform: translateX(-50%); bottom: -44px;" src="{{ url_for('static', filename='imgs/bar.png') }}"> -->

    <div class="d-flex flex-column justify-content-center align-items-center vh-100 vw-100 position-relative z-3">
        <div class="d-flex flex-column flex-grow-1 justify-content-end px-2 py-3 gap-4" id="answer" style="width: 600px;"></div>

        <div class="d-flex flex-column align-items-center justify-content-start gap-3" style="width: 400px; height: 250px;">
            <textarea class="form-control rounded-2 p-3" id="message" placeholder="Entrez votre message"></textarea>

            <div class="d-flex align-items-center justify-content-between w-100">
                <span class="ico ico-multi-bubble p-3"></span>
                
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-primary btn-lg bg-black border-black rounded-circle p-2" id="speak">
                        <span class="ico ico-microphone-speaking"></span>
                    </button>
                    
                    <button class="btn btn-secondary btn-lg bg-white border-white rounded-circle p-2" id="call-receptionist">
                        <span class="ico ico-arrow-right"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const message = document.getElementById("message");
        const answer = document.getElementById("answer");
        
        const speakButton = document.getElementById("speak");
        const callReceptionistButton = document.getElementById("call-receptionist");

        // gestion de la reconnaissance vocale
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = "fr-FR";

        speakButton.addEventListener("click", () => {
            recognition.start();
        });
    
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            message.innerHTML = transcript;

            callReceptionistButton.click();
        };

        // gestion de la synthèse vocale
        const synth = window.speechSynthesis;

        const speak = (text) => {
            const utterance = new SpeechSynthesisUtterance(text);
            synth.speak(utterance);
        };

        // gestion de l'appel au réceptionniste
        callReceptionistButton.addEventListener("click", function() {
            answer.innerHTML += getMyElement(message.value);

            fetch(`{{ url_for('chat_with_receptionist') }}?message=${message.value}`)
                .then(response => response.text())
                .then(data => {
                    // TODO : son de la synthèse vocale
                    // speak(data);

                    // answer.innerHTML += getReceptionistElement(data);
                })
                .catch(error => console.error('Error:', error));
        });

        function getReceptionistElement(data) {
            return 
            `
                <div class="d-flex justify-content-end w-100">
                    <div class="position-relative d-flex bg-light-gray text-black rounded-4 p-4" style="width: 90%;">
                        <div class="position-absolute bg-white text-black px-3 py-1 top-0 rounded-pill" style="right: 26px; transform: translateY(-50%);">Hôtelier</div>
                        ${data}
                    </div>
                </div>
            `;
        }

        function getMyElement(data) {
            return 
            `
                <div class="d-flex justify-content-start w-100">
                    <div class="position-relative d-flex bg-dark-gray text-white rounded-4 p-4" style="width: 90%;">
                        <div class="position-absolute bg-white text-black px-3 py-1 top-0 rounded-pill" style="left: 32px; transform: translateY(-50%);">Vous</div>
                        ${data}
                    </div>
                </div>
            `;
        }
    </script>
    <script type="importmap">
        {
            "imports": {
            "three": "https://unpkg.com/three/build/three.module.js",
            "three/examples/jsm/": "https://unpkg.com/three/examples/jsm/"
            }
        }
    </script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>